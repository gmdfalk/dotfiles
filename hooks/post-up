#!/usr/bin/env sh

# {{{ Configuration
LOGFILE="post-up.log"
# }}}

# {{{ Utilities
logger() { echo "$(date +'[ %d %b %Y %H %M ]') :: $*" | tee -a $log; }
# }}}

fix_permissions() {
    local arg

    for arg; do
        logger "Fixing permissions for $arg"
        if [ -d "$arg" ]; then
            chmod 700 "$arg"
        elif [ -f "$arg" ]; then
            chmod 600 "$arg"
        fi
    done
}

configure_vim() {
    local vim_dir="$HOME/.vim"
    local plug_file="$vim_dir/autoload/plug.vim"

    mkdir -p "$vim_dir/swaps" "$vim_dir/backups"
    if [ ! -f "$plug_file" ]; then
        curl -fLo "$plug_file" --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    fi

    vim +PlugInstall! +qa
}

install_cygwin_packages() {
    logger "Installing apt-cyg and curl"
    lynx -source rawgit.com/transcode-open/apt-cyg/master/apt-cyg > apt-cyg &&
    chmod a+x apt-cyg && cp apt-cyg /bin/ && rm apt-cyg &&
    # Install some essential packages
    apt-cyg install chere ctags curl gcc-g++ make mintty mysql mysqld openssl screen tar vim vim-common wget which ncurses ruby git &&
    gem install hub
    if [ $? -ne 0 ]; then
        logger "Could not install curl. You will need to install it via the Cygwin Installer"
    fi


}

apply_system_specific_setup() {

    # Architecture specific actions
    OS=$(uname -o)

    case "$OS" in
        Cygwin)
            install_cygwin_packages
            echo "Remember to change the cygwin link to '.../mintty.exe /usr/bin/zsh -' to use zsh by default" 
            ;;
        GNU/Linux)
            ;;
        Darwin)
            ;;
        *) 
            logger "Did not recognize Operating System $OS"
            ;;
    esac
}

main() {
    fix_permissions ~/.config/gnupg ~/.ssh
    apply_system_specific_setup
    configure_vim
}

main

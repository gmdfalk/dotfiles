#!/usr/bin/env bash

# {{{ Configuration
VIM_DIR="${HOME}/.vim"
PLUG_DIR="${VIM_DIR}/autoload"
PLUG_URI="https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim"
VUNDLE_DIR="${VIM_DIR}/bundle/vundle"
VUNDLE_URI="https://github.com/gmarik/vundle.git"
# }}}

# {{{ Utilities
logger() { echo "$@"; }

sync_repo() {
    local repo_path="$1"
    local repo_uri="$2"
    local repo_branch="$3"

    logger "Trying to install/update ${repo_path} from ${repo_uri} (${repo_branch})"

    if [[ ! -e "$repo_path" ]]; then
        mkdir -p "$repo_path"
        git clone -b "$repo_branch" "$repo_uri" "$repo_path" &&
        logger "Successfully cloned ${repo_name}."
    else
        cd "$repo_path" && git pull origin "$repo_branch" &&
        logger "Successfully updated ${repo_name}."
    fi
}
# }}}

# {{{ Routines
fix_permissions() {
    for arg in "$@"; do
        logger "Fixing permissions for ${arg}"
        setfacl -b "${arg}"
        if [[ -d "${arg}" ]]; then
            chmod 0700 "${arg}"
        elif [[ -f "${arg}" ]]; then
            chmod 0600 "${arg}"
        fi
    done
}

install_vimplug() {
    mkdir -p "${VIM_DIR}/{swaps,backups}"
    if [[ ! -f "${PLUG_DIR}/plug.vim" ]]; then
        curl -fLo "${PLUG_DIR}/plug.vim" --create-dirs "${PLUG_URI}"
    fi

    vim -u "NORC" "+set nomore" "+PlugInstall!" "+PlugClean" "+qall"
}

install_vundle() {
    mkdir -p "${VUNDLE_DIR}"
    sync_repo "${VUNDLE_DIR}" "${VUNDLE_URI}" "master"
    vim -u "NORC" "+set nomore" "+BundleInstall!" "+BundleClean" "+qall"
}

install_cygwin_packages() {
    logger "Installing apt-cyg and curl"
    #lynx -source rawgit.com/transcode-open/apt-cyg/master/apt-cyg > /bin/apt-cyg &&
    svn --force export http://apt-cyg.googlecode.com/svn/trunk/ /bin/ 
    chmod +x /bin/apt-cyg
    # Install some essential packages
    apt-cyg install chere ctags gcc-g++ make mintty mysql mysqld openssl screen tar vim vim-common wget which ncurses ruby git
    gem install hub
    apt-cyg install curl
    if [ $? -ne 0 ]; then
        logger "Could not install curl. You will need to install it via the Cygwin Installer"
    fi
}

apply_system_specific_setup() {
    local system="$(uname -o)"

    case "$system" in
        Cygwin)
            install_cygwin_packages
            echo "Remember to change the cygwin link to '.../mintty.exe /usr/bin/zsh -' to use zsh by default"
            ;;
        GNU/Linux)
            ;;
        Darwin)
            ;;
        *)
            logger "Did not recognize Operating System $system"
            ;;
    esac
}
# }}}

main() {
    fix_permissions ~/.config/gnupg ~/.ssh ~/.ssh/config

    apply_system_specific_setup

    if [[ -f "${HOME}/.vimrc.bundles" ]]; then
        install_vundle
    else
        install_vimplug
    fi
}

main

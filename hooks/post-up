#!/usr/bin/env bash

# Configuration {{{
VIM_DIR="${HOME}/.vim"
PLUG_DIR="${VIM_DIR}/autoload"
PLUG_URI="https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim"
VUNDLE_DIR="${VIM_DIR}/bundle/vundle"
VUNDLE_URI="https://github.com/VundleVim/Vundle.vim.git"
# }}}

# Utilities {{{
logger() { echo; echo "$@"; echo; }

have() {
    type "$@" &>/dev/null
}

sync_repo() {
    local repo_path="$1"
    local repo_uri="$2"
    local repo_branch="$3"

    logger "Trying to install/update ${repo_uri} (${repo_branch}) in ${repo_path}."

    if [[ -d "${repo_path}/.git" ]]; then
        cd "${repo_path}" && git pull origin "${repo_branch}" &&
        logger "Successfully updated ${repo_path}."
    else
        mkdir -p "${repo_path}"
        git clone -b "${repo_branch}" "${repo_uri}" "${repo_path}" &&
        logger "Successfully cloned to ${repo_path}."
    fi
}

# On cygwin (at least) setfacl does not have the -R switch (recursive) so we have to implement it ourselves.
fix_acls() {
    setfacl -b "${path}"
    [[ -d "${path}" ]] && fix_acls "${path}"/*
}

fix_permissions() {
    for arg in "$@"; do
        logger "Fixing permissions for ${arg} recursively."
        find "${arg}" -type d -exec chmod 0700 {} \;
        find "${arg}" -type f -exec chmod 0600 {} \;
        have setfacl && fix_acls "${arg}"
    done
}
# }}}

# Install Routines {{{
install_vimplug() {
    logger "Installing vimplug"
    mkdir -p "${VIM_DIR}/{swaps,backups}"
    if [[ ! -f "${PLUG_DIR}/plug.vim" ]]; then
        curl -fLo "${PLUG_DIR}/plug.vim" --create-dirs "${PLUG_URI}"
    fi

    vim "+set nomore" "+PlugInstall" "+PlugClean" "+qall"
}

install_vundle() {
    logger "Installing vundle"
    mkdir -p "${VUNDLE_DIR}"
    sync_repo "${VUNDLE_DIR}" "${VUNDLE_URI}" "master"
    vim "+set nomore" "+BundleInstall" "+BundleClean" "+qall"
}

# Cygwin switched to sha512 sums for verifying packages but apt-cyg as of late still uses md5 so we fix the binary here.
patch_apt_cyg_binary() {
    logger "Patching the apt-cyg binary."
    sed -i 's/md5sum/sha512sum/g' /bin/apt-cyg
}

update_apt_cyg() {
    if ! have apt-cyg; then
        logger "Installing apt-cyg."
        have lynx && lynx -source rawgit.com/transcode-open/apt-cyg/master/apt-cyg > /bin/apt-cyg
        have apt-cyg || wget  -O /bin/apt-cyg rawgit.com/transcode-open/apt-cyg/master/apt-cyg
        chmod +x /bin/apt-cyg
    fi
    patch_apt_cyg_binary
    logger "Updating apt-cyg."
    apt-cyg update
}

install_cygwin_packages() {
    update_apt_cyg

    local packages=(
        ctags gcc-g++ vim-common ncurses ruby-devel # meta packages
        chere curl mintty openssl ruby screen tar tmux wget which zsh # base packages
        git make mysql mysqld vim # dev packages
    )

    logger "Installing cygwin packages: ${packages[@]}"
    apt-cyg install "${packages[@]}"
}

install_gems() {
    local packages=(hub rdoc)

    logger "Installing gems: ${packages[@]}"
    gem install "${packages[@]}"
}

apply_system_specific_setup() {
    local system="$(uname)"

    case "$system" in
        Cygwin)
            logger "Applying system specific setup for Cygwin."
            install_cygwin_packages
            install_gems
            echo "Remember to change the cygwin link to '.../mintty.exe /usr/bin/zsh -' to use zsh by default"
            ;;
        GNU/Linux) ;;
        Darwin) ;;
        *) logger "Did not recognize Operating System: $system" ;;
    esac
}
# }}}

main() {
    fix_permissions ~/.gnupg ~/.ssh

    apply_system_specific_setup

    # Vimplug is used for the vim-minimal tag and vundle is used by vim-spf13.
    [[ -f "${HOME}/.vimrc.bundles" ]] && install_vundle || install_vimplug
}

main
